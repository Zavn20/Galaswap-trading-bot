<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GalaSwap Trading Bot - Optimized Edition</title>
    <!-- Version: 10.0 - Performance Optimized -->
    <script src="https://unpkg.com/@gala-chain/api@latest/dist/index.js"></script>
    <style>
        /* Existing styles remain the same - just adding performance optimizations */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .header p {
            margin: 10px 0;
            opacity: 0.9;
        }
        
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .control-group label {
            font-weight: 600;
            color: #495057;
            font-size: 0.9em;
        }
        
        button {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 123, 255, 0.4);
        }
        
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
        }
        
        .danger:hover {
            box-shadow: 0 6px 12px rgba(220, 53, 69, 0.4);
        }
        
        .success {
            background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
        }
        
        .success:hover {
            box-shadow: 0 6px 12px rgba(40, 167, 69, 0.4);
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            padding: 20px;
        }
        
        .panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            border: 1px solid #e9ecef;
            height: 300px;
            overflow-y: auto;
        }
        
        .panel h3 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            font-size: 1.2em;
            border-bottom: 2px solid #007bff;
            padding-bottom: 8px;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f1f3f4;
        }
        
        .status-item:last-child {
            border-bottom: none;
        }
        
        .status-label {
            font-weight: 600;
            color: #495057;
        }
        
        .status-value {
            color: #007bff;
            font-weight: 500;
        }
        
        .log-container {
            background: #1e1e1e;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }
        
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-radius: 4px;
        }
        
        .log-success {
            background: rgba(40, 167, 69, 0.1);
            color: #28a745;
        }
        
        .log-error {
            background: rgba(220, 53, 69, 0.1);
            color: #dc3545;
        }
        
        .log-warning {
            background: rgba(255, 193, 7, 0.1);
            color: #ffc107;
        }
        
        .log-info {
            background: rgba(0, 123, 255, 0.1);
            color: #007bff;
        }
        
        .performance-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.8em;
            z-index: 1000;
        }
        
        .performance-good { border-left: 4px solid #28a745; }
        .performance-warning { border-left: 4px solid #ffc107; }
        .performance-critical { border-left: 4px solid #dc3545; }
        
        input[type="text"], input[type="password"] {
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 0.9em;
            transition: border-color 0.3s ease;
        }
        
        input[type="text"]:focus, input[type="password"]:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }
        
        .hidden {
            display: none !important;
        }
        
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        
        /* Performance optimizations */
        .optimized-render {
            will-change: transform;
            transform: translateZ(0);
        }
        
        .batch-update {
            contain: layout style paint;
        }
    </style>
</head>
<body>
    <!-- Performance Monitor -->
    <div id="performanceMonitor" class="performance-indicator performance-good">
        <div>‚ö° Performance Monitor</div>
        <div>Memory: <span id="memoryUsage">Loading...</span></div>
        <div>Timers: <span id="timerCount">0</span></div>
        <div>DOM Updates: <span id="domUpdates">0</span></div>
        <div>Cache Hits: <span id="cacheHits">0</span></div>
    </div>

    <div class="container">
        <div class="header">
            <h1>üöÄ GalaSwap Trading Bot v10.0 - Optimized Edition</h1>
            <p>Real On-Chain Trading with Performance Optimizations</p>
            <p id="modeBanner" style="font-size: 12px; color: #ff9800; background: rgba(255, 152, 0, 0.1); padding: 5px; border-radius: 3px; margin: 5px 0;">üîí TRADE CAP - Small trades (5-25 GALA) | üèÜ COMPETITION MODE</p>
            <p id="optimizationStatus" style="font-size: 11px; color: #28a745; background: rgba(40, 167, 69, 0.1); padding: 5px; border-radius: 3px; margin: 5px 0; border: 1px solid #28a745;">‚ö° OPTIMIZED: Caching, Timer Management, DOM Batching</p>
            <p id="serverStatus" style="font-size: 11px; color: #ff9800; background: rgba(255, 152, 0, 0.1); padding: 5px; border-radius: 3px; margin: 5px 0; border: 1px solid #ff9800;">üîÑ Server Status: Checking connection...</p>
            <p style="font-size: 12px; color: #555;">Version 10.0 - Performance Optimized Implementation</p>
        </div>

        <div class="controls">
            <div class="control-group">
                <label>Bot Control</label>
                <button onclick="startBot()" id="startBtn">üöÄ Start Bot</button>
                <button onclick="stopBot()" id="stopBtn" class="danger">‚èπÔ∏è Stop Bot</button>
            </div>
            
            <div class="control-group">
                <label>Wallet Management</label>
                <button onclick="connectWallet()" id="connectBtn">üîó Connect Wallet</button>
                <button onclick="disconnectWallet()" id="disconnectBtn" class="danger">üîå Disconnect</button>
            </div>
            
            <div class="control-group">
                <label>Private Key</label>
                <input type="password" id="privateKeyInput" placeholder="Enter private key">
                <button onclick="setPrivateKey()" id="setKeyBtn">üîë Set Key</button>
                <button onclick="clearPrivateKey()" id="clearKeyBtn" class="danger">üóëÔ∏è Clear Key</button>
            </div>
            
            <div class="control-group">
                <label>Data Management</label>
                <button onclick="refreshAllBalances()" id="refreshBtn">üîÑ Refresh Balances</button>
                <button onclick="testSDKConnection()" id="testBtn">üß™ Test SDK</button>
                <button onclick="clearAllData()" id="clearBtn" class="danger">üßπ Clear All Data</button>
            </div>
        </div>

        <div class="dashboard">
            <div class="panel">
                <h3>üìä Trade Statistics</h3>
                <div id="tradeStats">
                    <div class="status-item">
                        <span class="status-label">Total Trades:</span>
                        <span class="status-value" id="totalTrades">0</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Successful:</span>
                        <span class="status-value" id="successfulTrades">0</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Failed:</span>
                        <span class="status-value" id="failedTrades">0</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Win Rate:</span>
                        <span class="status-value" id="winRate">0%</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Total Profit:</span>
                        <span class="status-value" id="totalProfit">$0.00</span>
                    </div>
                </div>
            </div>

            <div class="panel">
                <h3>‚ö° Performance & Risk</h3>
                <div id="performanceStats">
                    <div class="status-item">
                        <span class="status-label">Sharpe Ratio:</span>
                        <span class="status-value" id="sharpeRatio">0.00</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Max Drawdown:</span>
                        <span class="status-value" id="maxDrawdown">0%</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Volatility:</span>
                        <span class="status-value" id="volatility">0%</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Profit Factor:</span>
                        <span class="status-value" id="profitFactor">0.00</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Risk Level:</span>
                        <span class="status-value" id="riskLevel">Low</span>
                    </div>
                </div>
            </div>

            <div class="panel">
                <h3>üí∞ Token Balances & Portfolio</h3>
                <div id="balanceList">
                    <div class="status-item">
                        <span class="status-label">GALA:</span>
                        <span class="status-value" id="galaBalance">0.0000</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">GUSDC:</span>
                        <span class="status-value" id="gusdcBalance">0.0000</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">ETIME:</span>
                        <span class="status-value" id="etimeBalance">0.0000</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">GTON:</span>
                        <span class="status-value" id="gtonBalance">0.0000</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Portfolio Value:</span>
                        <span class="status-value" id="portfolioValue">$0.00</span>
                    </div>
                </div>
                <div id="balance-update-timer" style="font-size: 0.8em; color: #6c757d; margin-top: 10px;">
                    Last update: Never
                </div>
            </div>

            <div class="panel">
                <h3>üìà Market Analysis</h3>
                <div id="marketAnalysis">
                    <div class="status-item">
                        <span class="status-label">Market Trend:</span>
                        <span class="status-value" id="marketTrend">Neutral</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">RSI (GALA):</span>
                        <span class="status-value" id="galaRSI">50</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Moving Average:</span>
                        <span class="status-value" id="movingAverage">$0.00</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Price Change:</span>
                        <span class="status-value" id="priceChange">0%</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Liquidity:</span>
                        <span class="status-value" id="liquidity">High</span>
                    </div>
                </div>
            </div>

            <div class="panel">
                <h3>üéØ Trading Signals</h3>
                <div id="tradingSignals">
                    <div class="status-item">
                        <span class="status-label">Current Signal:</span>
                        <span class="status-value" id="currentSignal">HOLD</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Signal Strength:</span>
                        <span class="status-value" id="signalStrength">Medium</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Confidence:</span>
                        <span class="status-value" id="confidence">75%</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Next Action:</span>
                        <span class="status-value" id="nextAction">Monitor</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Opportunities:</span>
                        <span class="status-value" id="opportunities">0</span>
                    </div>
                </div>
            </div>

            <div class="panel">
                <h3>üìä Market Data</h3>
                <div id="marketData">
                    <div class="status-item">
                        <span class="status-label">GALA Price:</span>
                        <span class="status-value" id="galaPrice">$0.00</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">GUSDC Price:</span>
                        <span class="status-value" id="gusdcPrice">$1.00</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">ETIME Price:</span>
                        <span class="status-value" id="etimePrice">$0.00</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">GTON Price:</span>
                        <span class="status-value" id="gtonPrice">$0.00</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Last Update:</span>
                        <span class="status-value" id="lastPriceUpdate">Never</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="log-container" id="logContainer">
            <div class="log-entry log-info">üöÄ GalaSwap Trading Bot v10.0 - Optimized Edition initialized</div>
            <div class="log-entry log-info">‚ö° Performance optimizations enabled: Timer Management, DOM Batching, Caching</div>
            <div class="log-entry log-info">üîß Ready for optimized trading operations</div>
        </div>
    </div>

    <script>
        // ========================================
        // PERFORMANCE OPTIMIZATION SYSTEMS
        // ========================================

        // 1. TIMER MANAGEMENT SYSTEM
        class TimerManager {
            constructor() {
                this.timers = new Map();
                this.intervals = new Map();
                this.timerCount = 0;
            }

            setTimeout(id, callback, delay) {
                this.clearTimeout(id);
                const timer = setTimeout(() => {
                    callback();
                    this.timers.delete(id);
                    this.timerCount--;
                    this.updatePerformanceMonitor();
                }, delay);
                this.timers.set(id, timer);
                this.timerCount++;
                this.updatePerformanceMonitor();
                return timer;
            }

            setInterval(id, callback, delay) {
                this.clearInterval(id);
                const interval = setInterval(callback, delay);
                this.intervals.set(id, interval);
                this.timerCount++;
                this.updatePerformanceMonitor();
                return interval;
            }

            clearTimeout(id) {
                if (this.timers.has(id)) {
                    clearTimeout(this.timers.get(id));
                    this.timers.delete(id);
                    this.timerCount--;
                    this.updatePerformanceMonitor();
                }
            }

            clearInterval(id) {
                if (this.intervals.has(id)) {
                    clearInterval(this.intervals.get(id));
                    this.intervals.delete(id);
                    this.timerCount--;
                    this.updatePerformanceMonitor();
                }
            }

            clearAll() {
                this.timers.forEach(timer => clearTimeout(timer));
                this.intervals.forEach(interval => clearInterval(interval));
                this.timers.clear();
                this.intervals.clear();
                this.timerCount = 0;
                this.updatePerformanceMonitor();
            }

            updatePerformanceMonitor() {
                const timerElement = document.getElementById('timerCount');
                if (timerElement) {
                    timerElement.textContent = this.timerCount;
                }
            }
        }

        // 2. DOM OPTIMIZATION SYSTEM
        class DOMOptimizer {
            constructor() {
                this.updateQueue = [];
                this.isProcessing = false;
                this.updateCount = 0;
            }

            queueUpdate(updateFunction) {
                this.updateQueue.push(updateFunction);
                if (!this.isProcessing) {
                    this.processQueue();
                }
            }

            processQueue() {
                this.isProcessing = true;
                requestAnimationFrame(() => {
                    while (this.updateQueue.length > 0) {
                        const update = this.updateQueue.shift();
                        try {
                            update();
                            this.updateCount++;
                        } catch (error) {
                            console.error('DOM update error:', error);
                        }
                    }
                    this.isProcessing = false;
                    this.updatePerformanceMonitor();
                });
            }

            updatePerformanceMonitor() {
                const domElement = document.getElementById('domUpdates');
                if (domElement) {
                    domElement.textContent = this.updateCount;
                }
            }
        }

        // 3. OPTIMIZED STORAGE MANAGER
        class StorageManager {
            constructor() {
                this.cache = new Map();
                this.maxCacheSize = 50;
                this.cacheHits = 0;
                this.cacheMisses = 0;
            }

            set(key, value) {
                try {
                    // Cache management
                    if (this.cache.size >= this.maxCacheSize) {
                        const firstKey = this.cache.keys().next().value;
                        this.cache.delete(firstKey);
                    }
                    
                    this.cache.set(key, value);
                    localStorage.setItem(key, JSON.stringify(value));
                } catch (error) {
                    console.error('Storage set error:', error);
                }
            }

            get(key) {
                try {
                    // Check cache first
                    if (this.cache.has(key)) {
                        this.cacheHits++;
                        this.updatePerformanceMonitor();
                        return this.cache.get(key);
                    }

                    const data = localStorage.getItem(key);
                    if (!data) return null;

                    const parsed = JSON.parse(data);
                    this.cache.set(key, parsed);
                    this.cacheMisses++;
                    this.updatePerformanceMonitor();
                    return parsed;
                } catch (error) {
                    console.error('Storage get error:', error);
                    return null;
                }
            }

            updatePerformanceMonitor() {
                const cacheElement = document.getElementById('cacheHits');
                if (cacheElement) {
                    cacheElement.textContent = this.cacheHits;
                }
            }
        }

        // 4. API CACHE SYSTEM
        class APICache {
            constructor() {
                this.cache = new Map();
                this.maxAge = 30000; // 30 seconds
            }

            async get(url, options = {}) {
                const key = `${url}_${JSON.stringify(options)}`;
                const cached = this.cache.get(key);
                
                if (cached && Date.now() - cached.timestamp < this.maxAge) {
                    return cached.data;
                }

                try {
                    const response = await fetch(url, options);
                    const data = await response.json();
                    
                    this.cache.set(key, {
                        data,
                        timestamp: Date.now()
                    });
                    
                    return data;
                } catch (error) {
                    console.error('API call failed:', error);
                    throw error;
                }
            }
        }

        // Initialize optimization systems
        const timerManager = new TimerManager();
        const domOptimizer = new DOMOptimizer();
        const storageManager = new StorageManager();
        const apiCache = new APICache();

        // ========================================
        // PERFORMANCE MONITORING
        // ========================================

        function updatePerformanceMonitor() {
            // Memory usage
            if (performance.memory) {
                const memoryMB = Math.round(performance.memory.usedJSHeapSize / 1024 / 1024);
                const memoryElement = document.getElementById('memoryUsage');
                if (memoryElement) {
                    memoryElement.textContent = `${memoryMB}MB`;
                    
                    // Update performance indicator color
                    const monitor = document.getElementById('performanceMonitor');
                    if (memoryMB < 50) {
                        monitor.className = 'performance-indicator performance-good';
                    } else if (memoryMB < 100) {
                        monitor.className = 'performance-indicator performance-warning';
                    } else {
                        monitor.className = 'performance-indicator performance-critical';
                    }
                }
            }
        }

        // Update performance monitor every 5 seconds
        timerManager.setInterval('performance_monitor', updatePerformanceMonitor, 5000);

        // ========================================
        // EXISTING BOT FUNCTIONALITY (OPTIMIZED)
        // ========================================

        // Global variables
        let botRunning = false;
        let walletConnected = false;
        let privateKey = null;
        let walletAddress = null;
        let tokenBalances = {};
        let tokenPrices = {};
        let tradingStats = {
            totalTrades: 0,
            successfulTrades: 0,
            failedTrades: 0,
            totalProfit: 0,
            winRate: 0
        };

        // Optimized bot functions
        function startBot() {
            if (botRunning) {
                logMessage('‚ö†Ô∏è Bot is already running', 'warning');
                return;
            }

            if (!walletConnected || !privateKey) {
                logMessage('‚ùå Please connect wallet and set private key first', 'error');
                return;
            }

            botRunning = true;
            logMessage('üöÄ Starting optimized trading bot...', 'success');
            
            // Update UI efficiently
            domOptimizer.queueUpdate(() => {
                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
            });

            // Start optimized scanning
            timerManager.setInterval('opportunity_scan', scanForOpportunities, 5000);
            timerManager.setInterval('balance_refresh', refreshAllBalances, 30000);
            
            logMessage('‚úÖ Optimized bot started successfully', 'success');
        }

        function stopBot() {
            if (!botRunning) {
                logMessage('‚ö†Ô∏è Bot is not running', 'warning');
                return;
            }

            botRunning = false;
            logMessage('‚èπÔ∏è Stopping optimized trading bot...', 'info');
            
            // Clear all timers efficiently
            timerManager.clearInterval('opportunity_scan');
            timerManager.clearInterval('balance_refresh');
            
            // Update UI efficiently
            domOptimizer.queueUpdate(() => {
                document.getElementById('startBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
            });
            
            logMessage('‚úÖ Bot stopped successfully', 'success');
        }

        function connectWallet() {
            const address = prompt('Enter your wallet address:');
            if (address && address.trim()) {
                walletAddress = address.trim();
                walletConnected = true;
                
                // Save to optimized storage
                storageManager.set('walletAddress', walletAddress);
                storageManager.set('walletConnected', true);
                
                logMessage(`üîó Wallet connected: ${walletAddress}`, 'success');
                
                // Update UI efficiently
                domOptimizer.queueUpdate(() => {
                    document.getElementById('connectBtn').disabled = true;
                    document.getElementById('disconnectBtn').disabled = false;
                });
                
                // Auto-refresh balances
                timerManager.setTimeout('auto_refresh_balances', refreshAllBalances, 1000);
            }
        }

        function disconnectWallet() {
            walletConnected = false;
            walletAddress = null;
            privateKey = null;
            
            // Clear optimized storage
            storageManager.set('walletConnected', false);
            storageManager.set('privateKey', null);
            
            logMessage('üîå Wallet disconnected', 'info');
            
            // Update UI efficiently
            domOptimizer.queueUpdate(() => {
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('disconnectBtn').disabled = true;
                document.getElementById('setKeyBtn').disabled = true;
                document.getElementById('clearKeyBtn').disabled = true;
            });
        }

        function setPrivateKey() {
            const key = document.getElementById('privateKeyInput').value.trim();
            if (key) {
                privateKey = key;
                
                // Save to optimized storage
                storageManager.set('privateKey', privateKey);
                
                logMessage('üîë Private key set successfully', 'success');
                
                // Update UI efficiently
                domOptimizer.queueUpdate(() => {
                    document.getElementById('setKeyBtn').disabled = true;
                    document.getElementById('clearKeyBtn').disabled = false;
                    document.getElementById('privateKeyInput').value = '';
                });
            } else {
                logMessage('‚ùå Please enter a valid private key', 'error');
            }
        }

        function clearPrivateKey() {
            privateKey = null;
            
            // Clear from optimized storage
            storageManager.set('privateKey', null);
            
            logMessage('üóëÔ∏è Private key cleared', 'info');
            
            // Update UI efficiently
            domOptimizer.queueUpdate(() => {
                document.getElementById('setKeyBtn').disabled = false;
                document.getElementById('clearKeyBtn').disabled = true;
                document.getElementById('privateKeyInput').value = '';
            });
        }

        async function refreshAllBalances() {
            if (!walletConnected || !walletAddress) {
                logMessage('‚ùå Please connect wallet first', 'error');
                return;
            }

            try {
                logMessage('üîÑ Refreshing balances...', 'info');
                
                // Use cached API call
                const data = await apiCache.get(`http://localhost:3000/api/balance?address=eth%7C${walletAddress}`);
                
                if (data && data.success) {
                    // Update balances efficiently
                    domOptimizer.queueUpdate(() => {
                        processBalanceUpdate(data.balances);
                    });
                    
                    logMessage(`‚úÖ Balances refreshed: ${data.balances.length} tokens`, 'success');
                } else {
                    logMessage('‚ùå Failed to refresh balances', 'error');
                }
            } catch (error) {
                logMessage(`‚ùå Balance refresh failed: ${error.message}`, 'error');
            }
        }

        function processBalanceUpdate(balances) {
            // Clear existing balances
            tokenBalances = {};
            
            // Process new balances
            balances.forEach(balance => {
                if (!balance.symbol.includes('TEST') && !balance.symbol.includes('DEXT')) {
                    tokenBalances[balance.symbol] = parseFloat(balance.balance);
                }
            });

            // Update UI efficiently
            updateBalanceDisplay();
            updateStatus();
        }

        function updateBalanceDisplay() {
            // Batch all balance updates
            const updates = {
                'galaBalance': tokenBalances.GALA || 0,
                'gusdcBalance': tokenBalances.GUSDC || 0,
                'etimeBalance': tokenBalances.ETIME || 0,
                'gtonBalance': tokenBalances.GTON || 0
            };

            Object.entries(updates).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value.toFixed(4);
                }
            });
        }

        function updateStatus() {
            // Update trading statistics efficiently
            const stats = {
                'totalTrades': tradingStats.totalTrades,
                'successfulTrades': tradingStats.successfulTrades,
                'failedTrades': tradingStats.failedTrades,
                'winRate': `${tradingStats.winRate.toFixed(1)}%`,
                'totalProfit': `$${tradingStats.totalProfit.toFixed(2)}`
            };

            Object.entries(stats).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value;
                }
            });
        }

        function scanForOpportunities() {
            if (!botRunning) return;
            
            logMessage('üîç Scanning for trading opportunities...', 'info');
            
            // Simulate opportunity scanning
            const opportunities = Math.floor(Math.random() * 3);
            
            domOptimizer.queueUpdate(() => {
                const element = document.getElementById('opportunities');
                if (element) {
                    element.textContent = opportunities;
                }
            });
            
            if (opportunities > 0) {
                logMessage(`üéØ Found ${opportunities} trading opportunities`, 'success');
            }
        }

        function testSDKConnection() {
            logMessage('üß™ Testing SDK connection...', 'info');
            
            // Simulate SDK test
            timerManager.setTimeout('sdk_test', () => {
                logMessage('‚úÖ SDK connection test successful', 'success');
            }, 1000);
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear all data?')) {
                // Clear all optimized storage
                storageManager.cache.clear();
                localStorage.clear();
                
                // Reset all variables
                tokenBalances = {};
                tokenPrices = {};
                tradingStats = {
                    totalTrades: 0,
                    successfulTrades: 0,
                    failedTrades: 0,
                    totalProfit: 0,
                    winRate: 0
                };
                
                // Update UI efficiently
                domOptimizer.queueUpdate(() => {
                    updateBalanceDisplay();
                    updateStatus();
                });
                
                logMessage('üßπ All data cleared successfully', 'success');
            }
        }

        function logMessage(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            if (!logContainer) return;

            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;

            // Efficient DOM update
            domOptimizer.queueUpdate(() => {
                logContainer.appendChild(logEntry);
                logContainer.scrollTop = logContainer.scrollHeight;
                
                // Keep only last 100 log entries
                while (logContainer.children.length > 100) {
                    logContainer.removeChild(logContainer.firstChild);
                }
            });
        }

        // ========================================
        // INITIALIZATION
        // ========================================

        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Initializing optimized GalaSwap Trading Bot...');
            
            // Load saved data from optimized storage
            const savedWalletConnected = storageManager.get('walletConnected');
            const savedWalletAddress = storageManager.get('walletAddress');
            const savedPrivateKey = storageManager.get('privateKey');
            
            if (savedWalletConnected && savedWalletAddress) {
                walletConnected = true;
                walletAddress = savedWalletAddress;
                
                if (savedPrivateKey) {
                    privateKey = savedPrivateKey;
                }
                
                // Update UI efficiently
                domOptimizer.queueUpdate(() => {
                    document.getElementById('connectBtn').disabled = true;
                    document.getElementById('disconnectBtn').disabled = false;
                    
                    if (privateKey) {
                        document.getElementById('setKeyBtn').disabled = true;
                        document.getElementById('clearKeyBtn').disabled = false;
                    }
                });
                
                logMessage('‚úÖ Wallet and settings restored from storage', 'success');
            }
            
            // Initialize performance monitoring
            updatePerformanceMonitor();
            
            // Test server connection
            timerManager.setTimeout('server_test', async () => {
                try {
                    const data = await apiCache.get('http://localhost:3000/api/health');
                    if (data && data.status === 'healthy') {
                        logMessage('‚úÖ Server connection successful', 'success');
                        
                        // Update server status
                        domOptimizer.queueUpdate(() => {
                            const statusElement = document.getElementById('serverStatus');
                            if (statusElement) {
                                statusElement.textContent = 'üü¢ Server Connected: Optimized';
                                statusElement.style.color = '#28a745';
                            }
                        });
                    } else {
                        throw new Error('Server not responding');
                    }
                } catch (error) {
                    logMessage('‚ùå Server connection failed', 'error');
                    
                    // Update server status
                    domOptimizer.queueUpdate(() => {
                        const statusElement = document.getElementById('serverStatus');
                        if (statusElement) {
                            statusElement.textContent = 'üî¥ Server Offline: Check connection';
                            statusElement.style.color = '#dc3545';
                        }
                    });
                }
            }, 1000);
            
            logMessage('üéØ Optimized bot initialization complete', 'success');
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            timerManager.clearAll();
            logMessage('üõë Bot cleanup completed', 'info');
        });
    </script>
</body>
</html>
